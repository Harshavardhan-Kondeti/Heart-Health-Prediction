{% extends "base.html" %}
{% block content %}
<article>
  {% if request.query_params.get('email') == 'sent' %}
  <p style="color:#1b5e20; background:#e8f5e9; border:1px solid #c8e6c9; padding:0.5rem 0.75rem; border-radius:10px;">Email sent successfully with your report.</p>
  {% endif %}
  <div class="hero">
    <h2 style="margin:0;">Dashboard{% if user and user.full_name %}, {{ user.full_name }}{% endif %}</h2>
    <p style="margin:.3rem 0 0 0; color:#555;">Overview of your uploads and health summaries.</p>
  </div>
  {% if stats %}
  <div class="cards">
    <div class="card">
      <h3>Total Uploads</h3>
      <div class="value">{{ stats.total }}</div>
    </div>
    <div class="card ok">
      <h3>Normal</h3>
      <div class="value">{{ stats.normal }}</div>
    </div>
    <div class="card bad">
      <h3>Abnormal</h3>
      <div class="value">{{ stats.abnormal }}</div>
    </div>
    <div class="card small">
      <h3>Overall Report</h3>
      <div class="toolbar">
        <a role="button" class="contrast btn-sm" href="/fusion/report">Generate Overall Heart Report</a>
      </div>
    </div>
  </div>
  {% endif %}

  {% if submissions %}
  <h3 style="margin-top:1.5rem">Recent Uploads</h3>
  <div class="centered"><div class="panel">
  <table>
    <thead>
      <tr>
        <th>Date/Time</th>
        <th>File</th>
        <th>Test</th>
        <th>Result</th>
        <th>Score</th>
        <th>Report</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody>
      {% for s in submissions %}
      <tr>
        <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
        <td>{{ s.file_name }}</td>
        <td>{{ s.test_type }}</td>
        <td>{{ s.result }}</td>
        <td>{{ s.predicted_score }}</td>
        <td><a href="/ecg/report/{{ s.id }}" target="_blank">PDF</a></td>
        <td><a href="/ecg/report/{{ s.id }}/email">Send</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div></div>
  {% endif %}

  {% if result %}
  <h3>Latest Prediction</h3>
  {% if result.binary %}
    <p><strong>Result:</strong> {{ result.binary }}</p>
  {% endif %}
  {% if result.score is not none %}
    <p><strong>Score:</strong> {{ result.score }}</p>
  {% endif %}
  {% if result.probs %}
    <details>
      <summary>Class probabilities</summary>
      <ul>
      {% for cls, p in result.probs.items() %}
        <li>{{ cls }}: {{ p }}</li>
      {% endfor %}
      </ul>
    </details>
  {% endif %}
  {% if advice %}
    <p><strong>Advice:</strong> {{ advice }}</p>
  {% endif %}
  {% if submission %}
    <p>
      <a href="/ecg/report/{{ submission.id }}" target="_blank">Download PDF report</a>
      &nbsp;|&nbsp;
      <a href="/ecg/report/{{ submission.id }}/email">Email me this report</a>
    </p>
  {% endif %}
  {% if result.warning %}
  <p style="color:orange">{{ result.warning }}</p>
  {% endif %}
  {% endif %}

  <div class="toolbar" style="margin-top:1rem; justify-content:center;">
    <a role="button" href="/ecg/upload">Upload ECG</a>
    <a role="button" href="/ppg/upload">Upload PPG Image</a>
    <a role="button" href="/heart/upload">Upload Heart CSV</a>
  </div>
</article>
{% endblock %}
